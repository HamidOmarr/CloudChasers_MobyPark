# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: [self-hosted, linux, x64, mobypark]
    container:
      image: mcr.microsoft.com/dotnet/sdk:8.0
    env:
      DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      DOTNET_ROOT: ${{ github.workspace }}/.dotnet

    steps:
      - uses: actions/checkout@v4
      - name: Restore dependencies
        id: restore
        run: dotnet restore

      - name: Code format check
        id: format
        run: dotnet format --verify-no-changes

      - name: Build
        id: build
        run: dotnet build --no-restore -warnaserror

      - name: Test
        id: test
        run: dotnet test --no-build --verbosity minimal | tee test.log

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: test.log

      - name: Failure summary
        if: failure()
        shell: bash
        run: |
          bash ci/failure-summary.sh
        env:
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
          GITHUB_STEP_FORMAT_OUTCOME: ${{ steps.format.outcome }}
          GITHUB_STEP_BUILD_OUTCOME: ${{ steps.build.outcome }}
          GITHUB_STEP_TEST_OUTCOME: ${{ steps.test.outcome }}

  metrics:
    name: Metrics - job durations
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    permissions:
      actions: read
      contents: read
    steps:
      - name: Fetch jobs and compute durations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          
          jobs_json="$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs?per_page=100")"
          
          echo "$jobs_json" | jq -r '
            .jobs[]
            | select(.started_at != null and .completed_at != null)
            | [
                .name,
                .conclusion,
                .started_at,
                .completed_at
              ] | @tsv
          ' | while IFS=$'\t' read -r name conclusion started completed; do
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              duration=$((end_epoch - start_epoch))
          
              echo "job=$name conclusion=$conclusion duration_seconds=$duration started=$started completed=$completed"
          
              done
  failed-tests:
    name: Failed test summary (first test)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    steps:
      - name: Download test log
        uses: actions/download-artifact@v4
        with:
          name: test-log
          path: .

      - name: Write summary if tests failed
        shell: bash
        run: |
          set -euo pipefail
          
          if [ "${{ needs.build.result }}" != "failure" ]; then
            echo "✅ Build job did not fail; no failed-test summary needed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          
          echo "❌ Tests failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "First failing test:" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f test.log ]; then
            grep -m1 "Failed" test.log >> "$GITHUB_STEP_SUMMARY" || echo "(Could not find any 'failed' line in test.log)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(test.log not found)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Next step: run \`dotnet test\` locally for full details." >> "$GITHUB_STEP_SUMMARY"