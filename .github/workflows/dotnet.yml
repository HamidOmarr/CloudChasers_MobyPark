# CI/CD pipeline for building, testing, code coverage and resource metrics
name: .NET CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: [self-hosted, linux, x64, mobypark]

    container:
      image: mcr.microsoft.com/dotnet/sdk:8.0

    env:
      DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      DOTNET_ROOT: ${{ github.workspace }}/.dotnet
      MIN_BRANCH_COVERAGE: 80

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Code format check
      id: format
      run: dotnet format --verify-no-changes

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore

    - name: Install required tools
      run: |
        apt-get update
        apt-get install -y time bc

    - name: Run tests with coverage
      run: |
        echo "Running tests with Coverlet..."
        /usr/bin/time -v dotnet test --no-build --collect:"XPlat Code Coverage" \
          /p:CoverletOutput=./MobyPark.Tests/TestResults/Coverage \
          /p:CoverletOutputFormat=cobertura \
          /p:Include="[MobyPark.Services*]*" \
          | tee test.log

    - name: Install ReportGenerator
      run: |
        export PATH="$PATH:$HOME/.dotnet/tools"
        dotnet tool install -g dotnet-reportgenerator-globaltool || true
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Generate coverage report (TextSummary + HTML)
      run: |
        export PATH="$PATH:$HOME/.dotnet/tools"

        # Vind de laatste GUID-map van Coverlet
        LAST_COVERAGE_DIR=$(find ./MobyPark.Tests/TestResults/Coverage -mindepth 1 -maxdepth 1 -type d | sort -r | head -n1)
        
        if [ -z "$LAST_COVERAGE_DIR" ]; then
          echo "❌ Geen Coverlet output gevonden!"
          exit 1
        fi

        COVERAGE_FILE="$LAST_COVERAGE_DIR/coverage.cobertura.xml"

        if [ ! -f "$COVERAGE_FILE" ]; then
          echo "❌ Coverlet XML bestand niet gevonden in $LAST_COVERAGE_DIR"
          exit 1
        fi

        echo "Using coverage file: $COVERAGE_FILE"

        reportgenerator \
          "-reports:$COVERAGE_FILE" \
          "-targetdir:./MobyPark.Tests/TestResults/Coverage/CoverageReport" \
          "-reporttypes:TextSummary;Html" \
          -filters:"+[MobyPark.Services*]*"


    - name: Add coverage report summary to job summary
      run: |
        SUMMARY_FILE=./MobyPark.Tests/TestResults/Coverage/CoverageReport/Summary.txt

        echo "## Code Coverage (Services)" >> $GITHUB_STEP_SUMMARY
        cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY

    - name: Enforce branch coverage threshold (80%)
      run: |
        SUMMARY_FILE=./MobyPark.Tests/TestResults/Coverage/CoverageReport/Summary.txt
        BRANCH_COVERAGE=$(grep -oP '(?<=Branch coverage: )[0-9.]+' "$SUMMARY_FILE" || echo "0")
        echo "Branch coverage: $BRANCH_COVERAGE%"

        if (( $(echo "$BRANCH_COVERAGE < ${{ env.MIN_BRANCH_COVERAGE }}" | bc -l) )); then
          echo "❌ Branch coverage ($BRANCH_COVERAGE%) is below minimum threshold of ${{ env.MIN_BRANCH_COVERAGE }}%"
          exit 1
        else
          echo "✅ Branch coverage ($BRANCH_COVERAGE%) meets minimum threshold of ${{ env.MIN_BRANCH_COVERAGE }}%"
        fi

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./MobyPark.Tests/TestResults/Coverage/CoverageReport


    # Upload test log
    - name: Upload test log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-log
        path: test.log

    - name: Failure summary
      if: failure()
      shell: bash
      run: |
        bash ci/failure-summary.sh
      env:
        GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
        GITHUB_STEP_FORMAT_OUTCOME: ${{ steps.format.outcome }}
        GITHUB_STEP_BUILD_OUTCOME: ${{ steps.build.outcome }}
        GITHUB_STEP_TEST_OUTCOME: ${{ steps.test.outcome }}

  metrics:
    name: Metrics - job durations
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    permissions:
      actions: read
      contents: read
    steps:
      - name: Fetch jobs and compute durations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          
          jobs_json="$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs?per_page=100")"
          
          echo "$jobs_json" | jq -r '
            .jobs[]
            | select(.started_at != null and .completed_at != null)
            | [
                .name,
                .conclusion,
                .started_at,
                .completed_at
              ] | @tsv
          ' | while IFS=$'\t' read -r name conclusion started completed; do
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              duration=$((end_epoch - start_epoch))
          
              echo "job=$name conclusion=$conclusion duration_seconds=$duration started=$started completed=$completed"
          
              done
  failed-tests:
    name: Failed test summary (first test)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    steps:
      - name: Download test log
        uses: actions/download-artifact@v4
        with:
          name: test-log
          path: .

      - name: Write summary if tests failed
        shell: bash
        run: |
          set -euo pipefail
          
          if [ "${{ needs.build.result }}" != "failure" ]; then
            echo "✅ Build job did not fail; no failed-test summary needed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          
          echo "❌ Tests failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "First failing test:" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f test.log ]; then
            grep -m1 "Failed" test.log >> "$GITHUB_STEP_SUMMARY" || echo "(Could not find any 'failed' line in test.log)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(test.log not found)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Next step: run \`dotnet test\` locally for full details." >> "$GITHUB_STEP_SUMMARY"
