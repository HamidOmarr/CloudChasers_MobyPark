# CI/CD pipeline for building, testing, code coverage and resource metrics
name: .NET CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: [self-hosted, linux, x64, mobypark]

    container:
      image: mcr.microsoft.com/dotnet/sdk:8.0

    env:
      DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      DOTNET_ROOT: ${{ github.workspace }}/.dotnet
      MIN_BRANCH_COVERAGE: 80

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Restore dependencies
        id: restore
        run: dotnet restore
      

    - name: Code format check
      id: format
      run: dotnet format --verify-no-changes

    - name: Build   
      id: build
      run: dotnet build --no-restore -warnaserror

    - name: Test with coverage
      id: test
      run: |
        dotnet test \
          --no-build \
          --verbosity minimal \
          /p:CollectCoverage=true \
          /p:CoverletOutput=TestResults/Coverage/ \
          /p:CoverletOutputFormat=cobertura \
          /p:Include="[MobyPark]MobyPark.Services.*" \
          /p:Exclude="[MobyPark]MobyPark.Services.Results.*" \
          | tee test.log
    
    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    - name: Add dotnet tools to PATH
      run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Generate coverage summary
      run: |
        reportgenerator \
          -reports:"**/coverage.cobertura.xml" \
          -targetdir:"CoverageReport" \
          -reporttypes:"TextSummary"

    - name: Publish coverage summary
      if: always()
      run: |
        echo "## Code Coverage" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        cat CoverageReport/Summary.txt >> "$GITHUB_STEP_SUMMARY"

    - name: Check if code coverage is higher then threshold
      run: |
        coverage=$(grep "Line coverage:" CoverageReport/Summary.txt | awk '{print $3}' | tr -d '%')
        echo "Coverage is $coverage%"

        if (( $(echo "$coverage < $MIN_BRANCH_COVERAGE" | bc -l) )); then
          echo "❌ Code coverage ($coverage%) is below threshold ($MIN_BRANCH_COVERAGE%)" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        else
          echo "✅ Code coverage ($coverage%) meets the threshold ($MIN_BRANCH_COVERAGE%)" >> "$GITHUB_STEP_SUMMARY"
        fi

    - name: Collect Resource Usage Metrics
      if: always()
      shell: bash --noprofile --norc -e -o pipefail {0}
      run: |
        echo "## Resource Usage Metrics" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### CPU" >> "$GITHUB_STEP_SUMMARY"
        echo "CPU cores: $(nproc)" >> "$GITHUB_STEP_SUMMARY"
        # Load averages (1,5,15 min)
        read one five fifteen rest < /proc/loadavg
        echo "Load average (1,5,15 min): $one, $five, $fifteen" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### Memory" >> "$GITHUB_STEP_SUMMARY"
        mem_total_kb=$(awk '/MemTotal:/ {print $2}' /proc/meminfo)
        mem_free_kb=$(awk '/MemFree:/ {print $2}' /proc/meminfo)
        mem_available_kb=$(awk '/MemAvailable:/ {print $2}' /proc/meminfo)
        swap_used_kb=$(awk '/SwapTotal:/ {total=$2} /SwapFree:/ {free=$2} END {print total - free}' /proc/meminfo)
        echo "Total memory: $((mem_total_kb/1024)) MB" >> "$GITHUB_STEP_SUMMARY"
        echo "Free memory: $((mem_free_kb/1024)) MB" >> "$GITHUB_STEP_SUMMARY"
        echo "Available memory: $((mem_available_kb/1024)) MB" >> "$GITHUB_STEP_SUMMARY"
        echo "Swap usage: $((swap_used_kb/1024)) MB" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### Disk" >> "$GITHUB_STEP_SUMMARY"
        echo "Disk usage for workspace: $(du -sh $GITHUB_WORKSPACE | awk '{print $1}')" >> "$GITHUB_STEP_SUMMARY"
        echo "Disk free space: $(df -h $GITHUB_WORKSPACE | awk 'NR==2 {print $4 " free of " $2}')" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### Runtime" >> "$GITHUB_STEP_SUMMARY"
        echo "Job ID: $GITHUB_RUN_ID" >> "$GITHUB_STEP_SUMMARY"
        echo "Job start: $(date -u +"%d-%m-%Y %H:%M:%S")" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### Environment" >> "$GITHUB_STEP_SUMMARY"
        echo "OS: $(uname -a)" >> "$GITHUB_STEP_SUMMARY"
        echo ".NET SDK version: $(dotnet --version)" >> "$GITHUB_STEP_SUMMARY"
        echo "Container image: mcr.microsoft.com/dotnet/sdk:8.0" >> "$GITHUB_STEP_SUMMARY"
        echo "Workspace: $GITHUB_WORKSPACE" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "✅ Resource usage metrics collected successfully." >> "$GITHUB_STEP_SUMMARY"

    # Upload test log
    - name: Upload test log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-log
        path: test.log

    - name: Failure summary
      if: failure()
      shell: bash
      run: |
        bash ci/failure-summary.sh
      env:
        GITHUB_STEP_SUMMARY: ${{ github.step_summary }}
        GITHUB_STEP_FORMAT_OUTCOME: ${{ steps.format.outcome }}
        GITHUB_STEP_BUILD_OUTCOME: ${{ steps.build.outcome }}
        GITHUB_STEP_TEST_OUTCOME: ${{ steps.test.outcome }}

  metrics:
    name: Metrics - job durations
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    permissions:
      actions: read
      contents: read
    steps:
      - name: Fetch jobs and compute durations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          
          jobs_json="$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs?per_page=100")"
          
          echo "$jobs_json" | jq -r '
            .jobs[]
            | select(.started_at != null and .completed_at != null)
            | [
                .name,
                .conclusion,
                .started_at,
                .completed_at
              ] | @tsv
          ' | while IFS=$'\t' read -r name conclusion started completed; do
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              duration=$((end_epoch - start_epoch))
          
              echo "job=$name conclusion=$conclusion duration_seconds=$duration started=$started completed=$completed"
          
              done
  failed-tests:
    name: Failed test summary (first test)
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    steps:
      - name: Download test log
        uses: actions/download-artifact@v4
        with:
          name: test-log
          path: .

      - name: Write summary if tests failed
        shell: bash
        run: |
          set -euo pipefail
          
          if [ "${{ needs.build.result }}" != "failure" ]; then
            echo "✅ Build job did not fail; no failed-test summary needed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          
          echo "❌ Tests failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "First failing test:" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -f test.log ]; then
            grep -m1 "Failed" test.log >> "$GITHUB_STEP_SUMMARY" || echo "(Could not find any 'failed' line in test.log)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(test.log not found)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Next step: run \`dotnet test\` locally for full details." >> "$GITHUB_STEP_SUMMARY"
